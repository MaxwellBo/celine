<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bibhtml</title>
</head>

<body>
  <script type="module">
    import { Cite } from 'https://esm.sh/@citation-js/core'
    import 'https://esm.sh/@citation-js/plugin-bibtex'
    import 'https://esm.sh/@citation-js/plugin-doi'
    import 'https://esm.sh/@citation-js/plugin-csl'

    function alphabetize(n) {
      const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
      let out = "";
      while (n > 0) {
        const mod = (n - 1) % 26;
        out = alphabet[mod] + out;
        n = Math.floor((n - mod) / 26);
      }
      return out;
    }

    function anchorify(root, element, query) {
      element.onclick = () => {
        const target = root.querySelector(query);
        target.scrollIntoView();
        target.focus();
      };
    }

    class BibHTMLCite extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this._referenceIndex = null;
        this._citationIndex = null;
      }

      connectedCallback() {
        const bibliography = document.querySelector("bibhtml-bibliography");
        bibliography.addCitation(this.refId, this);
        this.render();
      }

      static get observedAttributes() {
        return ['ref'];
      }

      attributeChangedCallback(name, oldValue, newValue) {
        if (name === 'ref') {
          this.render();
        }
      }

      get refId() {
        return this.getAttribute('ref') || this.textContent.trim();
      }

      set referenceIndex(value) {
        this._referenceIndex = value;
        this.render();
      }

      set citationIndex(value) {
        this._citationIndex = value;
        this.render();
      }

      render() {
        const bibliography = document.querySelector("bibhtml-bibliography");
        const link = document.createElement('a');
        const citationShorthand = alphabetize(this._citationIndex + 1);
        link.href = `#ref-${this.refId}`;
        link.id = `cite-${this.refId}-${citationShorthand}`;
        link.textContent = `[${this._referenceIndex + 1}]`;
        anchorify(bibliography.shadowRoot, link, `#ref-${this.refId}`);

        this.shadowRoot.replaceChildren(link);
      }
    }

    class BibHTMLEntry extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this._citation = null;
      }

      async connectedCallback() {
        try {
          if (this._citation) {
            return;
          }

          this._citation = await Cite.async(this.textContent);
          const bibliography = document.querySelector("bibhtml-bibliography");
          bibliography.addEntry(this._citation.data[0]['citation-key'], this);
        } catch (e) {
          console.error('Error parsing citation entry:', e);
        }
      }

      format(template = 'apa') {
        if (!this._citation) return '';
        const entry = this._citation.data[0];
        const { author, title, journal, volume, number, pages, publisher, address, month, howpublished, issued } = entry;

        let formattedEntry = '';

        if (author) {
          const authors = author.map(a => `${a.given} ${a.family}`).join(', ');
          formattedEntry += `${authors}. `;
        }
        if (title) {
          formattedEntry += `<i>${title}</i>. `;
        }
        if (journal) {
          formattedEntry += `${journal}, `;
        }
        if (volume) {
          formattedEntry += `vol. ${volume}, `;
        }
        if (number) {
          formattedEntry += `no. ${number}, `;
        }
        if (pages) {
          formattedEntry += `pp. ${pages}, `;
        }
        if (issued && issued['date-parts'] && issued['date-parts'][0]) {
          const year = issued['date-parts'][0][0];
          formattedEntry += `(${year}). `;
        }
        if (publisher) {
          formattedEntry += `${publisher}, `;
        }
        if (address) {
          formattedEntry += `${address}, `;
        }
        if (month) {
          formattedEntry += `${month}, `;
        }
        if (howpublished) {
          formattedEntry += `${howpublished}. `;
        }
        return formattedEntry.trim();
      }

      render() {
        const node = document.createElement('span');
        node.innerHTML = this.format();
        this.shadowRoot.replaceChildren(node);
      }
    }

    class BibHTMLBibliography extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.refToEntries = new Map();
        this.refToCitations = new Map();
      }

      async connectedCallback() {
        this.render();
      }

      addEntry(key, entry) {
        this.refToEntries.set(key, entry);
        this.render();
      }

      addCitation(key, citation) {
        if (!this.refToCitations.has(key)) {
          this.refToCitations.set(key, []);
        }
        this.refToCitations.get(key).push(citation);
        this.render();
      }

      render() {
        const list = document.createElement('ol');

        let referenceIndex = 0;
        for (const [ref, citations] of this.refToCitations.entries()) {
          let citationIndex = 0;
          for (const citation of citations) {
            citation.referenceIndex = referenceIndex;
            citation.citationIndex = citationIndex;
            citation.render();
            citationIndex++;
          }

          const entry = this.refToEntries.get(ref);
          if (!entry) {
            continue;
          }

          const item = document.createElement('li');
          entry.render();
          item.appendChild(entry);
          item.id = `ref-${ref}`;

          const backlinks = document.createElement('sup');

          if (citations.length === 1) {
            const backlink = document.createElement('a');
            backlink.href = `#cite-${ref}-a`;
            backlink.textContent = '^';
            backlinks.appendChild(backlink);
            anchorify(citations[0].shadowRoot, backlink, `#cite-${ref}-a`);
          } else {
            let i = 0;
            backlinks.textContent = '^';
            backlinks.appendChild(document.createTextNode(' '));

            for (const citation of citations) {
              const citationShorthand = alphabetize(i + 1);
              const backlink = document.createElement('a');
              backlink.href = `#cite-${ref}-${citationShorthand}`;
              backlink.textContent = citationShorthand;
              anchorify(citation.shadowRoot, backlink, `#cite-${ref}-${citationShorthand}`);
              backlinks.appendChild(document.createTextNode(' '));
              backlinks.appendChild(backlink);
              i++;
            }
          }

          backlinks.appendChild(document.createTextNode(' '));
          item.prepend(backlinks);
          list.appendChild(item);
          referenceIndex++;
        };

        this.shadowRoot.replaceChildren(list);
      }
    }

    customElements.define('bibhtml-bibliography', BibHTMLBibliography);
    customElements.define('bibhtml-reference', BibHTMLEntry);
    customElements.define('bibhtml-cite', BibHTMLCite);
  </script>

  <h3><a id="citation-web-component" href="#citation-web-component"></a>Citation Web Component</h3>

  <blockquote>
    <p>
      The accurate determination of college students' coefficients of friction is a fascinating
      topic.<sup><bibhtml-cite>Cummings2003</bibhtml-cite></sup>
    </p>
    <p>
      The Mathematical Theory of Efficient Piracy provides deep
      insights.<sup><bibhtml-cite>Napster1998</bibhtml-cite></sup>
      The Mathematical Theory of Efficient Piracy is often referenced in discussions about digital
      rights.<sup><bibhtml-cite>Napster1998</bibhtml-cite></sup>
    </p>
    <p>
      Wikidata ref <sup><bibhtml-cite>10.7717/peerj-cs.214</bibhtml-cite></sup>
    </p>
    <p>
      The history of the goofy layout of keyboards is quite
      interesting.<sup><bibhtml-cite>Qwerty1996</bibhtml-cite></sup>
    </p>
    <p>
      Sigmund Freud once mentioned this in a personal conversation.<sup><bibhtml-cite>Freud2012</bibhtml-cite></sup>
    </p>

  </blockquote>

  <div style="height: 2000px; background-color: lightgray;"></div>

  <b>Bibliography</b>
  <bibhtml-bibliography>
    <bibhtml-reference>
      @article{Cummings2003,
      author = {Arthur B Cummings and David Eftekhary and Frank G House},
      title = {The accurate determination of college students' coefficients of friction},
      journal = {Journal of Sketchy Physics},
      volume = {13},
      year = {2003},
      number = {2},
      pages = {46--129}
      }
    </bibhtml-reference>
    <bibhtml-reference>
      @book{Napster1998,
      author = {L M Napster},
      title = {Mathematical Theory of Efficient Piracy},
      series = {Lecture Notes in Mathematics},
      volume = {3204},
      publisher = {Springer Verlag},
      address = {New York NY},
      year = {1998}
      }
    </bibhtml-reference>
    <bibhtml-reference>
      @phdthesis{Qwerty1996,
      author = {O P Qwerty},
      title = {History of the Goofy Layout of Keyboards},
      publisher = {Podunk University Arcana Department},
      address = {Podunk IN},
      year = {1996}
      }
    </bibhtml-reference>
    <bibhtml-reference>
      @misc{Freud2012,
      author = {Sigmund Freud},
      month = {July},
      year = {2012},
      howpublished = {Personal conversation}
      }
    </bibhtml-reference>
    <bibhtml-reference>
      Q30000000
    </bibhtml-reference>
  </bibhtml-bibliography>
</body>

</html>