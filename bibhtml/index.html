<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bibhtml</title>
  <link rel="stylesheet" href="../libertine/libertine.css">
  <link rel="stylesheet" href="../celine/cell.css">
  <script type="module">
    import { CelineModule, registerScriptReevaluationOnBlur } from 'https://esm.sh/jsr/@celine/celine@3.0.0';
    import * as Inputs from 'https://esm.run/@observablehq/inputs@0.12.0';
    import * as htl from 'https://esm.run/htl@0.3.1';

    window.celine = CelineModule.usingNewObservableRuntimeAndModule(document);
    window.library = celine.library; /* @observablehq/stdlib */
    window.Inputs = Inputs;
    window.htl = htl;
    console.log(window.celine)

    registerScriptReevaluationOnBlur(document, /*class=*/'echo');
  </script>
</head>

<body>
  <script type="module">
    import { Cite } from 'https://esm.sh/@citation-js/core'
    import 'https://esm.sh/@citation-js/plugin-bibtex'
    import 'https://esm.sh/@citation-js/plugin-doi'
    import 'https://esm.sh/@citation-js/plugin-csl'
    import 'https://esm.sh/@citation-js/plugin-wikidata'

    function alphabetize(n) {
      const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
      let out = "";
      while (n > 0) {
        const mod = (n - 1) % 26;
        out = alphabet[mod] + out;
        n = Math.floor((n - mod) / 26);
      }
      return out;
    }

    function anchorify(root, element, query) {
      element.onclick = () => {
        const target = root.querySelector(query);
        target.scrollIntoView();
        target.focus();
      };
    }

    class BibHTMLCite extends HTMLElement {
      constructor() {
        super();
        this._referenceIndex = null;
        this._citationIndex = null;
      }

      connectedCallback() {
        const bibliography = document.querySelector("bibhtml-bibliography");
        bibliography.addCitation(this.refId, this);
      }

      static get observedAttributes() {
        return ['ref'];
      }

      attributeChangedCallback(name, oldValue, newValue) {
        if (name === 'ref') {
          this.render();
        }
      }

      get refId() {
        return this.getAttribute('ref') || this.textContent.trim();
      }

      set referenceIndex(value) {
        this._referenceIndex = value;
        this.render();
      }

      set citationIndex(value) {
        this._citationIndex = value;
        this.render();
      }

      render() {
        if (this._referenceIndex === null || this._citationIndex === null) {
          return;
        }

        if (!this.shadowRoot) {
          this.attachShadow({ mode: 'open' });
        }

        const bibliography = document.querySelector("bibhtml-bibliography");
        const link = document.createElement('a');
        const citationShorthand = alphabetize(this._citationIndex + 1);

        link.href = `#${this.refId}`;
        anchorify(bibliography.shadowRoot, link, `#${this.refId}`);

        link.id = `cite-${this.refId}-${citationShorthand}`;
        link.textContent = `[${this._referenceIndex + 1}]`;

        this.shadowRoot.replaceChildren(link);
      }
    }

    class BibHTMLReference extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this._citation = null;
        this._notifiedBibliography = false;
      }

      async connectedCallback() {
        const bibliography = document.querySelector("bibhtml-bibliography");
        try {
          if (!this._citation) {
            this._citation = await Cite.async(this.textContent);
          }
        } catch (e) {
          console.log('Could not parse <bibhtml-reference> innerText with Citation.js. See https://citation.js.org/ for valid formats. innerText was:', this.textContent, e);
        }

        if (!this._notifiedBibliography) {
          this._notifiedBibliography = true;
          bibliography.addReference(this.id, this);
        }
      }

      format(template) {
        return this._citation.format('bibliography', {
          format: 'html',
          template
        });
      }

      render(template = 'apa') {
        // gracefully degrade
        if (!this._citation) {
          this.shadowRoot.replaceChildren(document.createTextNode(this.textContent));
          return;
        }

        const tempTemplate = document.createElement('template');
        tempTemplate.innerHTML = this.format(template);

        const cslEntry = tempTemplate.content.querySelector('.csl-entry');
        cslEntry.style.display = 'inline-block';
        this.shadowRoot.replaceChildren(cslEntry);
      }
    }

    class BibHTMLBibliography extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.refIdToReference = new Map();
        this.refIdToCitations = new Map();
      }

      async connectedCallback() {
        this.render();
      }

      static get observedAttributes() {
        return ['format'];
      }

      attributeChangedCallback(name, oldValue, newValue) {
        if (name === 'format') {
          this.render();
        }
      }


      addReference(refId, reference) {
        this.refIdToReference.set(refId, reference);
        this.render();
      }

      addCitation(refId, citation) {
        if (!this.refIdToCitations.has(refId)) {
          this.refIdToCitations.set(refId, []);
        }
        this.refIdToCitations.get(refId).push(citation);
        this.render();
      }

      render() {
        const list = document.createElement('ol');

        let referenceIndex = 0;
        for (const [refId, citations] of this.refIdToCitations.entries()) {
          const reference = this.refIdToReference.get(refId);
          if (!reference) {
            continue;
          }

          let citationIndex = 0;
          for (const citation of citations) {
            citation.referenceIndex = referenceIndex;
            citation.citationIndex = citationIndex;
            citation.render();
            citationIndex++;
          }

          const item = document.createElement('li');
          reference.render(this.getAttribute('format'));
          item.appendChild(reference);
          item.id = `ref-${refId}`;

          const backlinks = document.createElement('sup');

          if (citations.length === 1) {
            const backlink = document.createElement('a');
            backlink.href = `#cite-${refId}-a`;
            anchorify(citations[0].shadowRoot, backlink, `#cite-${refId}-a`);

            backlink.textContent = '^';
            backlinks.appendChild(backlink);
          } else {
            let i = 0;
            backlinks.textContent = '^';
            backlinks.appendChild(document.createTextNode(' '));

            for (const citation of citations) {
              const citationShorthand = alphabetize(i + 1);
              const backlink = document.createElement('a');
              backlink.href = `#cite-${refId}-${citationShorthand}`;
              anchorify(citation.shadowRoot, backlink, `#cite-${refId}-${citationShorthand}`);

              backlink.textContent = citationShorthand;
              backlinks.appendChild(document.createTextNode(' '));
              backlinks.appendChild(backlink);
              i++;
            }
          }

          backlinks.appendChild(document.createTextNode(' '));
          item.prepend(backlinks);
          list.appendChild(item);
          referenceIndex++;
        };

        this.shadowRoot.replaceChildren(list);
      }
    }

    customElements.define('bibhtml-bibliography', BibHTMLBibliography);
    customElements.define('bibhtml-reference', BibHTMLReference);
    customElements.define('bibhtml-cite', BibHTMLCite);
  </script>

  <p>
    <a href="../index.html" style="text-decoration: none; font-family: 'Libertinus Sans', sans-serif">←
      @celine/celine</a>
  </p>

  <h1>@celine/bibhtml</h1>
  <div class="authors">
    <div class="author">
      <span class="author-name">Max Bo</span> <sup><a href="https://maxbo.me" style="text-decoration: none;">↗</a></sup>
    </div>
  </div>

  <p class="abstract">
    <cite>bibhtml</cite> is a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components">Web
      Components</a>-based referencing system for HTML documents. It aims to provide a similar user experience to
    referencing in LaTeX/BibTeX. While a wrapper around <a
      href="https://citation.js.org/">Citation.js</a><sup><bibhtml-cite>willighagen2019</bibhtml-cite></sup>, it
    gracefully degrades when JavaScript is disabled, or when references are malformed. <cite>bibhtml</cite> takes
    significant inspiration from <a href="https://github.com/citation-js/replacer">@citation-js/replacer</a>, <a
      href="https://lab.avl.la/references-webcomponent/">References Web Component</a> and <a
      href="https://nota-lang.org/reference.html#def-section-2.4">Nota
      Citations</a><sup><bibhtml-cite>crichton2021nota</bibhtml-cite></sup>.
  </p>

  <p>
    <cite>bibhtml</cite> is structured around 3 <a
      href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_custom_elements">custom elements</a>:
    <!-- <ol>
      <li>
      A <code>&lt;bibhtml-bibliography&gt;</code> which contains...
      </li>
      <li>
      <code>&lt;bibhtml-reference&gt;</code>s which are cited by...
      </li>
      <li>
      <code>&lt;bibhtml-cite&gt;</code>s inline in the text.
      </li>
    </ol> -->
  </p>

  <h2><code>&lt;bibhtml-bibliography&gt;</code></h2>

  <p>
    The <code>&lt;bibhtml-bibliography&gt;</code> contains <code>&lt;bibhtml-reference&gt;</code>s and renders them in a formatted list (like at the <a href="#references">bottom of the page</a>).
  </p>

  <p>
    The <code>format</code> attribute sets the citation style. Currently only <code>"apa"</code> (default) is supported.
  </p>
  <!-- TODO Get <code>"vancouver"</code> or <code>"harvard1"</code> working. -->
  <br />

  <pre class="echo">
&lt;bibhtml-bibliography format="apa"&gt;
  &lt;bibhtml-reference id="willighagen2019"&gt;
    @article{willighagen2019,
    title = {Citation.js: a format-independent, modular bibliography tool for the browser and command line},
    author = {Willighagen, Lars G.},
    year = 2019,
    month = aug,
    keywords = {Bibliography, Javascript},
    volume = 5,
    pages = {e214},
    journal = {PeerJ Computer Science},
    issn = {2376-5992},
    url = {https://doi.org/10.7717/peerj-cs.214},
    doi = {10.7717/peerj-cs.214}
    }
  &lt;/bibhtml-reference&gt;
  ...
&lt;/bibhtml-bibliography&gt;</pre>

  <!-- <script id="bibliography-cell" type="module">
    celine.cell("bibliography-cell", () => {
      return htl.html`<pre class='echo'>${document.getElementById('bibliography-container').innerHTML}</pre>`
    })
  </script> -->

  <h2><code>&lt;bibhtml-reference&gt;</code></h2>

  <p>
    The <code>&lt;bibhtml-reference&gt;</code> is tagged with the <code>id</code> attribute and contains reference information in 4 supported formats.
  </p>

  <h3>BibTeX</h3>

  <script id="bibtex-cell" type="module">
    celine.cell("bibtex-cell", () => {
      const reference = document.querySelector('bibhtml-bibliography').shadowRoot.getElementById('crichton2021nota');
      return htl.html`<pre class='echo'>${reference.outerHTML}</pre>`
    })
  </script>

  <p>
    This is backed by <a href="https://www.npmjs.com/package/@citation-js/plugin-bibtex">@citation-js/plugin-bibtex</a>.
  </p>

  <h3>Unstructured text</h3>

  <p>
    A <code>&lt;bibhtml-reference&gt;</code> can contain unstructured text. This format is useful when:
    <ul>
      <li>The reference is not in a machine readable format</li>
      <li>The reference is malformed</li>
      <li>The machine readable format is not supported by <cite>bibhtml</cite> or Citation.js</li>
    </ul>
  </p>

  <script id="text-cell" type="module">
    celine.cell("text-cell", () => {
      const reference = document.querySelector('bibhtml-bibliography').shadowRoot.getElementById('dunbar2017');
      return htl.html`<pre class='echo'>${reference.outerHTML}</pre>`
    })
  </script>

  <p>
    The Sun is hot<sup><bibhtml-cite>dunbar2017</bibhtml-cite></sup>.
  </p>

  <h3>DOI</h3>

  <script id="doi-cell" type="module">
    celine.cell("doi-cell", () => {
      const reference = document.getElementById('10.1080/15588742.2015.1017687');
      return htl.html`<pre class='echo'>${reference.outerHTML}</pre>`
    })
  </script>

  <p>
    This expands to a full reference: <bibhtml-cite ref="10.1080/15588742.2015.1017687"></bibhtml-cite>
  </p>


  <p>
    This is backed by <a href="https://www.npmjs.com/package/@citation-js/plugin-doi">@citation-js/plugin-doi</a>.
  </p>

  <h3>Wikidata</h3>

  <script id="wikidata-cell" type="module">
    celine.cell("wikidata-cell", () => {
      const reference = document.getElementById('Q21972834');
      return htl.html`<pre class='echo'>${reference.outerHTML}</pre>`
    })
  </script>

  <p>
    This expands to a full reference: <bibhtml-cite ref="Q21972834"></bibhtml-cite>
  </p>

  <p>
    This is backed by <a href="https://www.npmjs.com/package/@citation-js/plugin-wikidata">@citation-js/plugin-wikidata</a>.
  </p>


  <h2><code>&lt;bibhtml-cite&gt;</code></h2>

  <p>
    Say we wanted to cite <span
      id="inner-text-container">Citation.js<sup><bibhtml-cite>willighagen2019</bibhtml-cite></sup></span>,
    we'd use <code>&lt;bibhtml-cite&gt;</code> element:
  </p>

  <script id="inner-text-cell" type="module">
    celine.cell("inner-text-cell", () => {
      return htl.html`<pre class='echo'>${document.getElementById('inner-text-container').innerHTML}</pre>`
    })
  </script>

  <p>
    Alternatively, rather than citing <span id="ref-container">Citation.js<sup><bibhtml-cite ref="willighagen2019"><a
            href="https://citation.js.org/">Link</a></bibhtml-cite></sup></span> with the reference ID as the inner
    text, we can use the <code>ref</code> attribute to specify the ID. This allows you to put a fallback in the element
    if JavaScript fails to load:
  </p>

  <script id="ref-cell" type="module">
    celine.cell("ref-cell", () => {
      return htl.html`<pre class='echo'>${document.getElementById('ref-container').innerHTML}</pre>`
    })
  </script>

  <!-- <p>
    We can site using Nota<sup><bibhtml-cite>crichton2021nota</bibhtml-cite></sup> style citations. 
  </p> -->



  <!-- <script id="bib-cell" type="module">
    celine.cell("bib-cell", () => {
      const bib = document.getElementById('bo2024');
      return htl.html`<pre class='echo'>${bib.outerHTML}</pre>`
    })
  </script> -->

  <!-- <p>
    We can do free text references<sup><bibhtml-cite>bo2024</bibhtml-cite></sup>.
  </p> -->

  <p>
    When citing a <span id="missing-container">reference<sup><bibhtml-cite>freud2012</bibhtml-cite></sup></span> that is
    not in the bibliography, the inner text of the element will be displayed as a fallback:
  </p>

  <script id="missing-cell" type="module">
    celine.cell("missing-cell", () => {
      return htl.html`<pre class='echo'>${document.getElementById('missing-container').innerHTML}</pre>`
    })
  </script>


  <div style="height: 2000px; background-color: lightgrey;">
    This is a really long div.
  </div>

  <h2 id="references">References</h2>

<bibhtml-bibliography format="vancouver1">
<bibhtml-reference id="willighagen2019">
  @article{willighagen2019,
  title = {Citation.js: a format-independent, modular bibliography tool for the browser and command line},
  author = {Willighagen, Lars G.},
  year = 2019,
  month = aug,
  keywords = {Bibliography, Javascript},
  volume = 5,
  pages = {e214},
  journal = {PeerJ Computer Science},
  issn = {2376-5992},
  url = {https://doi.org/10.7717/peerj-cs.214},
  doi = {10.7717/peerj-cs.214}
  }
</bibhtml-reference>
<bibhtml-reference id="crichton2021nota">
  @inproceedings{crichton2021nota,
  title={A New Medium for Communicating Research on Programming Languages},
  author={Crichton, Will},
  booktitle={Proceedings of the 1st Workshop on Human Aspects of Types and Reasoning Assistants},
  year={2021}
  }
</bibhtml-reference>
<bibhtml-reference id="dunbar2017">
  Brian Dunbar (2017-08-03). The Sun | NASA. National Aeronautics and Space Administration. Accessed on
  2021-08-30.
</bibhtml-reference>
<bibhtml-reference id="10.1080/15588742.2015.1017687">
  10.1080/15588742.2015.1017687
</bibhtml-reference>
<bibhtml-reference id="Q21972834">
  Q21972834
</bibhtml-reference>
</bibhtml-bibliography>
</body>

</html>