<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bibhtml</title>
</head>

<body>
  <script type="module">
    import { Cite } from 'https://esm.sh/@citation-js/core'
    import 'https://esm.sh/@citation-js/plugin-bibtex'

    function alphabetize(n) {
      const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
      let out = "";
      while (n > 0) {
        const mod = (n - 1) % 26;
        out = alphabet[mod] + out;
        n = Math.floor((n - mod) / 26);
      }
      return out;
    }

    class BibHTMLCite extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this._referenceIndex = null;
        this._citationIndex = null;
      }

      connectedCallback() {
        this.render();
      }

      static get observedAttributes() {
        return ['ref'];
      }

      attributeChangedCallback(name, oldValue, newValue) {
        if (name === 'ref') {
          this.render();
        }
      }

      get refId() {
        return this.getAttribute('ref') || this.textContent.trim();
      }

      set referenceIndex(value) {
        this._referenceIndex = value;
        this.render();
      }

      set citationIndex(value) {
        this._citationIndex = value;
        this.render();
      }

      render() {
        const bibliography = document.querySelector("bibhtml-bibliography");
        const link = document.createElement('a');
        const citationShorthand = alphabetize(this._citationIndex + 1);
        link.href = `#ref-${this.refId}`;
        link.id = `cite-${this.refId}-${citationShorthand}`;
        link.textContent = `[${this._referenceIndex + 1}]`;
        link.onclick = () => {
          const reference = bibliography.shadowRoot.getElementById(`ref-${this.refId}`);
          if (reference) {
            reference.scrollIntoView();
            reference.focus();
          }
        };

        this.shadowRoot.replaceChildren(link);
      }
    }

    class BibHTMLEntry extends HTMLElement {
      constructor() {
        super();
        this._citation = null;
      }

      async connectedCallback() {
        try {
          this._citation = await new Cite(this.textContent);
          const bibliography = document.querySelector("bibhtml-bibliography");
          bibliography.addEntry(this._citation.data[0]['citation-key'], this);
        } catch (e) {
          console.error('Error parsing citation entry:', e);
        }
      }

      format(template = 'apa') {
        if (!this._citation) return '';
        const entry = this._citation.data[0];
        const { author, title, journal, volume, number, pages, publisher, address, month, howpublished, issued } = entry;

        let formattedEntry = '';

        if (author) {
          const authors = author.map(a => `${a.given} ${a.family}`).join(', ');
          formattedEntry += `${authors}. `;
        }
        if (title) {
          formattedEntry += `<i>${title}</i>. `;
        }
        if (journal) {
          formattedEntry += `${journal}, `;
        }
        if (volume) {
          formattedEntry += `vol. ${volume}, `;
        }
        if (number) {
          formattedEntry += `no. ${number}, `;
        }
        if (pages) {
          formattedEntry += `pp. ${pages}, `;
        }
        if (issued && issued['date-parts'] && issued['date-parts'][0]) {
          const year = issued['date-parts'][0][0];
          formattedEntry += `(${year}). `;
        }
        if (publisher) {
          formattedEntry += `${publisher}, `;
        }
        if (address) {
          formattedEntry += `${address}, `;
        }
        if (month) {
          formattedEntry += `${month}, `;
        }
        if (howpublished) {
          formattedEntry += `${howpublished}. `;
        }
        return formattedEntry.trim();
      }
    }

    class BibHTMLBibliography extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.entries = new Map();
      }

      connectedCallback() {
        this.render();
      }

      addEntry(key, entry) {
        this.entries.set(key, entry);
        this.render();
      }

      render() {
        const citedKeys = Array.from(this.entries.keys());
        const citations = document.querySelectorAll('bibhtml-cite');

        citations.forEach((citation, index) => {
          const refId = citation.refId;
          if (citedKeys.includes(refId)) {
            const refIndex = citedKeys.indexOf(refId);
            citation.referenceIndex = refIndex;
            citation.citationIndex = index;
          }
        });

        const list = document.createElement('ol');

        citedKeys.forEach((key) => {
          const entry = this.entries.get(key);
          if (!entry) {
            console.error(`Entry with key ${key} not found.`);
            return;
          }

          const item = document.createElement('li');
          item.innerHTML = entry.format();
          item.id = `ref-${key}`;

          const backlinks = document.createElement('sup');

          const citations = Array.from(document.querySelectorAll('bibhtml-cite')).filter(c => c.refId === key);
          console.log(citations);

          if (citations.length === 1) {
            const backlink = document.createElement('a');
            backlink.href = `#cite-${key}-a`;
            backlink.textContent = '^';
            backlinks.appendChild(backlink);
          } else {
            let i = 0;
            backlinks.textContent = '^';
            backlinks.appendChild(document.createTextNode(' '));

            for (const _ of citations) {
              console.log(i)
              const citationShorthand = alphabetize(i + 1);
              const backlink = document.createElement('a');
              backlink.href = `#cite-${key}-${citationShorthand}`;
              backlink.textContent = citationShorthand;
              backlinks.appendChild(document.createTextNode(' '));
              backlinks.appendChild(backlink);
              i++;
            }
          }

          backlinks.appendChild(document.createTextNode(' '));
          item.prepend(backlinks);
          list.appendChild(item);
        });

        this.shadowRoot.replaceChildren(list);
      }
    }

    customElements.define('bibhtml-cite', BibHTMLCite);
    customElements.define('bibhtml-entry', BibHTMLEntry);
    customElements.define('bibhtml-bibliography', BibHTMLBibliography);
  </script>

  <h3><a id="citation-web-component" href="#citation-web-component"></a>Citation Web Component</h3>

  <blockquote>
    <p>
      The accurate determination of college students' coefficients of friction is a fascinating
      topic.<sup><bibhtml-cite>Cummings2003</bibhtml-cite></sup>
    </p>
    <p>
      The Mathematical Theory of Efficient Piracy provides deep
      insights.<sup><bibhtml-cite>Napster1998</bibhtml-cite></sup>
      The Mathematical Theory of Efficient Piracy is often referenced in discussions about digital
      rights.<sup><bibhtml-cite>Napster1998</bibhtml-cite></sup>
    </p>
    <p>
      The history of the goofy layout of keyboards is quite
      interesting.<sup><bibhtml-cite>Qwerty1996</bibhtml-cite></sup>
    </p>
    <p>
      Sigmund Freud once mentioned this in a personal conversation.<sup><bibhtml-cite>Freud2012</bibhtml-cite></sup>
    </p>
  </blockquote>

  <div style="height: 2000px; background-color: lightgray;"></div>

  <b>Bibliography</b>
  <bibhtml-bibliography>
    <bibhtml-entry>
      @article{Cummings2003,
      author = {Arthur B Cummings and David Eftekhary and Frank G House},
      title = {The accurate determination of college students' coefficients of friction},
      journal = {Journal of Sketchy Physics},
      volume = {13},
      year = {2003},
      number = {2},
      pages = {46--129}
      }
    </bibhtml-entry>
    <bibhtml-entry>
      @book{Napster1998,
      author = {L M Napster},
      title = {Mathematical Theory of Efficient Piracy},
      series = {Lecture Notes in Mathematics},
      volume = {3204},
      publisher = {Springer Verlag},
      address = {New York NY},
      year = {1998}
      }
    </bibhtml-entry>
    <bibhtml-entry>
      @phdthesis{Qwerty1996,
      author = {O P Qwerty},
      title = {History of the Goofy Layout of Keyboards},
      publisher = {Podunk University Arcana Department},
      address = {Podunk IN},
      year = {1996}
      }
    </bibhtml-entry>
    <bibhtml-entry>
      @misc{Freud2012,
      author = {Sigmund Freud},
      month = {July},
      year = {2012},
      howpublished = {Personal conversation}
      }
    </bibhtml-entry>
  </bibhtml-bibliography>
</body>

</html>